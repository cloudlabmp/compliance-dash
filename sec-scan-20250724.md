# Container Security Scanning Guide - 2025-07-24

This document provides instructions for running security scans on the compliance-dash container images using Trivy and Docker Scout.

## Prerequisites

- Docker installed and running
- AWS CLI configured with ECR access
- Container images pushed to ECR

## Tools Installation

### Install Trivy Security Scanner

```bash
# Install Trivy to user bin directory
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ~/bin v0.57.0

# Add to PATH
export PATH="$HOME/bin:$PATH"

# Verify installation
trivy --version
```

### Docker Scout

Docker Scout comes bundled with Docker Desktop and recent Docker Engine versions:

```bash
# Verify Docker Scout availability
docker scout version
```

## Authentication Setup

### ECR Authentication

```bash
# Authenticate Docker with ECR
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 863518421854.dkr.ecr.us-east-1.amazonaws.com
```

## Scanning Commands

### Get Current Image URIs

```bash
# List current container images
cd terraform
terraform output container_image_uris
```

### Trivy Security Scans

#### Basic Vulnerability Scan (HIGH and CRITICAL only)
```bash
# Frontend container
trivy image --severity HIGH,CRITICAL --format table <ECR-FRONTEND-URI>

# Backend container  
trivy image --severity HIGH,CRITICAL --format table <ECR-BACKEND-URI>
```

#### Full Vulnerability Scan (All Severities)
```bash
# Frontend container - full scan
trivy image --severity LOW,MEDIUM,HIGH,CRITICAL --format table <ECR-FRONTEND-URI>

# Backend container - full scan
trivy image --severity LOW,MEDIUM,HIGH,CRITICAL --format table <ECR-BACKEND-URI>
```

#### Secrets Scanning
```bash
# Scan for hardcoded secrets
trivy image --scanners secret <ECR-FRONTEND-URI>
trivy image --scanners secret <ECR-BACKEND-URI>
```

#### JSON Output for Automation
```bash
# Generate JSON report for CI/CD integration
trivy image --format json --output frontend-scan.json <ECR-FRONTEND-URI>
trivy image --format json --output backend-scan.json <ECR-BACKEND-URI>
```

### Docker Scout Security Scans

#### Quick Overview
```bash
# Get quick security overview
docker scout quickview <ECR-FRONTEND-URI>
docker scout quickview <ECR-BACKEND-URI>
```

#### Detailed CVE Analysis
```bash
# Show only HIGH and CRITICAL vulnerabilities
docker scout cves <ECR-BACKEND-URI> --only-severity critical,high

# Show all vulnerabilities
docker scout cves <ECR-FRONTEND-URI>
docker scout cves <ECR-BACKEND-URI>
```

#### Base Image Recommendations
```bash
# Get base image update recommendations
docker scout recommendations <ECR-FRONTEND-URI>
docker scout recommendations <ECR-BACKEND-URI>
```

## Example Complete Scan Script

Create a script `scan-containers.sh`:

```bash
#!/bin/bash

# Set variables
REGION="us-east-1"
REGISTRY="863518421854.dkr.ecr.us-east-1.amazonaws.com"

# Get current build version
cd terraform
BUILD_VERSION=$(terraform output -raw current_build_version)
FRONTEND_URI="${REGISTRY}/compliance-dash-frontend:${BUILD_VERSION}"
BACKEND_URI="${REGISTRY}/compliance-dash-backend:${BUILD_VERSION}"

echo "Scanning images with build version: ${BUILD_VERSION}"
echo "Frontend: ${FRONTEND_URI}"
echo "Backend: ${BACKEND_URI}"

# ECR Authentication
echo "Authenticating with ECR..."
aws ecr get-login-password --region ${REGION} | docker login --username AWS --password-stdin ${REGISTRY}

# Trivy Scans
echo "=== TRIVY SECURITY SCANS ==="
echo "Frontend - Critical/High vulnerabilities:"
trivy image --severity HIGH,CRITICAL --format table ${FRONTEND_URI}

echo "Backend - Critical/High vulnerabilities:"
trivy image --severity HIGH,CRITICAL --format table ${BACKEND_URI}

echo "Frontend - Secret scan:"
trivy image --scanners secret ${FRONTEND_URI}

echo "Backend - Secret scan:"
trivy image --scanners secret ${BACKEND_URI}

# Docker Scout Scans
echo "=== DOCKER SCOUT SECURITY SCANS ==="
echo "Frontend - Quick overview:"
docker scout quickview ${FRONTEND_URI}

echo "Backend - Quick overview:"
docker scout quickview ${BACKEND_URI}

echo "Backend - Critical/High CVEs:"
docker scout cves ${BACKEND_URI} --only-severity critical,high

echo "Scan completed: $(date)"
```

Make executable and run:
```bash
chmod +x scan-containers.sh
./scan-containers.sh
```

## Automated Scanning Integration

### CI/CD Pipeline Integration

Add to your pipeline (e.g., GitHub Actions):

```yaml
- name: Security Scan with Trivy
  run: |
    trivy image --exit-code 1 --severity HIGH,CRITICAL ${{ env.IMAGE_URI }}
    
- name: Security Scan with Docker Scout
  run: |
    docker scout cves ${{ env.IMAGE_URI }} --exit-code --only-severity critical,high
```

### Scheduled Scanning

Create a cron job for regular scanning:

```bash
# Add to crontab (crontab -e)
0 2 * * 1 /path/to/scan-containers.sh > /path/to/security-scan.log 2>&1
```

## Security Thresholds

### Recommended Exit Criteria

- **CRITICAL vulnerabilities:** 0 allowed
- **HIGH vulnerabilities:** < 5 allowed
- **Secrets:** 0 allowed
- **Base image updates:** Review monthly

### Vulnerability Severity Guidelines

- **CRITICAL (9.0-10.0):** Immediate action required
- **HIGH (7.0-8.9):** Fix within 7 days
- **MEDIUM (4.0-6.9):** Fix within 30 days
- **LOW (0.1-3.9):** Fix within 90 days

## Troubleshooting

### Common Issues

1. **ECR Authentication Fails:**
   ```bash
   aws sts get-caller-identity  # Verify AWS credentials
   aws ecr describe-repositories --region us-east-1  # Test ECR access
   ```

2. **Trivy Database Updates:**
   ```bash
   trivy image --reset  # Reset Trivy cache
   ```

3. **Docker Scout Rate Limits:**
   - Scout has rate limits for unauthenticated users
   - Consider Docker Hub authentication for higher limits

### Performance Tips

- Use `--quiet` flag to reduce output verbosity
- Add `--skip-dirs` to exclude unnecessary directories
- Use `--scanners vuln` to disable secret scanning if not needed

## Report Generation

Generate formatted reports:

```bash
# HTML report
trivy image --format template --template "@contrib/html.tpl" -o report.html <IMAGE-URI>

# SARIF report for GitHub
trivy image --format sarif -o report.sarif <IMAGE-URI>
```

---

**Last Updated:** 2025-07-24  
**Trivy Version:** v0.57.0  
**Docker Scout Version:** v1.18.2  
**Next Review:** 2025-08-24